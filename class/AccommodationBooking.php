<?php/* * To change this license header, choose License Headers in Project Properties. * To change this template file, choose Tools | Templates * and open the template in the editor. *//** * Description of Attractions * * @author chalana dulaj */class AccommodationBooking {    public $id;    public $booking_id;    public $customer_id;    public $visitor_id;    public $acc_id;    public $room_id;    public $check_in;    public $check_out;    public $rooms;    public $adults;    public $child;    public $price;    public $message;    public $status;    public $queue;    public function __construct($id) {        if ($id) {            $query = "SELECT * FROM `accommodation_booking` WHERE `id`=" . $id;            $db = new Database();            $result = mysqli_fetch_array($db->readQuery($query));            $this->id = $result['id'];            $this->booking_id = $result['booking_id'];            $this->customer_id = $result['customer_id'];            $this->visitor_id = $result['visitor_id'];            $this->acc_id = $result['acc_id'];            $this->room_id = $result['room_id'];            $this->check_in = $result['check_in'];            $this->check_out = $result['check_out'];            $this->rooms = $result['rooms'];            $this->adults = $result['adults'];            $this->child = $result['child'];            $this->price = $result['price'];            $this->message = $result['message'];            $this->status = $result['status'];            $this->queue = $result['queue'];            return $this;        }    }    public function create() {        $query = "INSERT INTO `accommodation_booking` (`booking_id`,`customer_id`,`visitor_id`,`acc_id`,`room_id`,`check_in`,`check_out`,`rooms`,`adults`,`child`,`price`,`message`,`queue`) VALUES  ('"                . $this->booking_id . "','"                . $this->customer_id . "','"                . $this->visitor_id . "', '"                . $this->acc_id . "', '"                . $this->room_id . "', '"                . $this->check_in . "', '"                . $this->check_out . "', '"                . $this->rooms . "', '"                . $this->adults . "', '"                . $this->child . "', '"                . $this->price . "', '"                . $this->message . "', '"                . $this->queue . "')";        $db = new Database();        $result = $db->readQuery($query);        if ($result) {            $last_id = mysqli_insert_id();            return $this->__construct($last_id);        } else {            return FALSE;        }    }    public function all() {        $query = "SELECT * FROM `accommodation_booking` ORDER BY queue ASC";        $db = new Database();        $result = $db->readQuery($query);        $array_res = array();        while ($row = mysqli_fetch_array($result)) {            array_push($array_res, $row);        }        return $array_res;    }    public function getBookingdByAccId($acc_id) {        $query = "SELECT * FROM `accommodation_booking` WHERE `acc_id`= $acc_id ORDER BY queue ASC";        $db = new Database();        $result = $db->readQuery($query);        $array_res = array();        while ($row = mysqli_fetch_array($result)) {            array_push($array_res, $row);        }        return $array_res;    }    public function getBookingdByCustomer($customer_id) {        $query = "SELECT * FROM `accommodation_booking` WHERE `customer_id`= $customer_id ORDER BY queue ASC";        $db = new Database();        $result = $db->readQuery($query);        $array_res = array();        while ($row = mysqli_fetch_array($result)) {            array_push($array_res, $row);        }        return $array_res;    }    public function getBookingByCustomerAndPending($customer_id) {        $query = "SELECT * FROM `accommodation_booking` WHERE `customer_id`= $customer_id AND `status`= 0 ORDER BY queue ASC";        $db = new Database();        $result = $db->readQuery($query);        $array_res = array();        while ($row = mysqli_fetch_array($result)) {            array_push($array_res, $row);        }        return $array_res;    }    public function getBookingdByAccIdAndDiffDate($acc_id, $start_date, $end_date) {        $query = "SELECT * FROM `accommodation_booking` WHERE  `check_in` between '$start_date' AND '$end_date' AND `acc_id`= $acc_id ORDER BY queue ASC";        $db = new Database();        $result = $db->readQuery($query);        $array_res = array();        while ($row = mysqli_fetch_array($result)) {            array_push($array_res, $row);        }        return $array_res;    }    public function update() {        $query = "UPDATE  `accommodation_booking` SET "                . "`customer_id` ='" . $this->customer_id . "', "                . "`visitor_id` ='" . $this->visitor_id . "', "                . "`acc_id` ='" . $this->acc_id . "', "                . "`room_id` ='" . $this->room_id . "', "                . "`queue` ='" . $this->queue . "' "                . "WHERE `id` = '" . $this->id . "'";        $db = new Database();        $result = $db->readQuery($query);        if ($result) {            return $this->__construct($this->id);        } else {            return FALSE;        }    }    public function getBookingFilterByCustomer($date_range, $search_key, $customer) {        $query = "SELECT *  FROM `accommodation_booking`";        if (!empty($date_range)) {            $date_arr = explode("-", $date_range);            $start_date = explode(" ", str_replace("/", "-", $date_arr[0]));            $due_date = explode(" ", str_replace("/", "-", $date_arr[1]));            $query .= " WHERE  `check_in` between '$start_date[0]' AND '$due_date[1]' ";        }        if (!empty($search_key)) {            $query .= "AND `booking_id` LIKE '%" . $search_key . "%'";        }        $query .= "AND `customer_id` =$customer ORDER BY queue ASC  ";        $db = new Database();        $result = $db->readQuery($query);        $out_put = '';        $key = 1;        while ($row = mysqli_fetch_array($result)) {            $INVOICE = new Invoice(NULL);            $ROOM = new Room($row['room_id']);            $ACCOMMODATION = new Accommodation($row['acc_id']);            $ACCOMMODATION_TYPE = new AccommodationType($ACCOMMODATION->type);            $CUSTOMER = new Customer($ACCOMMODATION->customer_id);            $LAST_ID = $INVOICE->getCountByAccommodationId($row['acc_id']) + 1;            $STATUS_ID = $INVOICE->getInvoiceStatusByAccId($row['acc_id']);            $INV = new Invoice($STATUS_ID);            $check_in = date_create($row['check_in']);            $check_out = date_create($row['check_out']);            $out_put .= '<tr>                                               <td>                                            ' . $key++ . '                                         </td>                                        <td>                                            <a href="#">' . $row['booking_id'] . '</a>                                        </td>                                        <td> ';            $out_put .= ' ' . date_format($check_in, "y/m/d") . ' - ' . date_format($check_out, "m/d") . '                                                                                  </td>                                        <td><span class="invoice-amount">' . $ROOM->title . '</span></td>                                                                               <td ><span class="text-danger"><b>$' . $row['price'] . '</b></span><span class="text-dark"> - (' . $row['rooms'] . ')</span></td>';            if ($row['status'] == 0) {                $out_put .= '   <td><span class="badge badge-light-warning badge-pill">PENDING..!</span></td>';            } else if ($row['status'] == 1) {                $out_put .= '<td><span class="badge badge-light-success badge-pill">CONFIRMED..!</span></td>';            } else {                $out_put .= ' <td><span class="badge badge-light-danger badge-pill">CANCELED..!</span></td>';            }//                       $out_put .= '       <td>                                            <div class="dropdown">                                                <span class="bx bx-dots-vertical-rounded font-medium-3 dropdown-toggle nav-hide-arrow cursor-pointer"                                                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="menu"></span>                                                <div class="dropdown-menu dropdown-menu-right">                                                    <a class="dropdown-item" target="_blank" href="edit-hotel-booking.php?id=' . $row['id'] . '"><i class="bx bx-calendar mr-1"></i> Manage Booking</a>                                                   <a class="dropdown-item" target="_blank" href="#"><i class="bx bx-trash mr-1"></i> delete Booking</a>                                                </div>                                            </div>                                        </td>                                    </tr>                                     ';        }        if (!empty($out_put)) {            echo $out_put;        } else {            echo $out_put = '<td style = "color: red;font-weight: 600;width: 155px;">No Booking..!</td>';        }    }    public function getBookingByFilter($date_range, $search_key) {        $query = "SELECT distinct(`acc_id`)  FROM `accommodation_booking`";        if (!empty($date_range)) {            $date_arr = explode("-", $date_range);            $start_date = explode(" ", str_replace("/", "-", $date_arr[0]));            $due_date = explode(" ", str_replace("/", "-", $date_arr[1]));            $query .= " WHERE  `check_in` between '$start_date[0]' AND '$due_date[1]' ";        }        if (!empty($search_key)) {            $query .= "AND `booking_id` LIKE '%" . $search_key . "%'";        }        $query .= "ORDER BY queue ASC  ";        $db = new Database();        $result = $db->readQuery($query);        $out_put = '';        $key = 1;        while ($row = mysqli_fetch_array($result)) {            $INVOICE = new Invoice(NULL);            $ACCOMMODATION = new Accommodation($row['acc_id']);            $ACCOMMODATION_TYPE = new AccommodationType($ACCOMMODATION->type);            $CUSTOMER = new Customer($ACCOMMODATION->customer_id);            $LAST_ID = $INVOICE->getCountByAccommodationId($row['acc_id']) + 1;            $STATUS_ID = $INVOICE->getInvoiceStatusByAccId($row['acc_id']);            $INV = new Invoice($STATUS_ID);            $out_put .= '<tr>                                               <td>                                            ' . $key++ . '                                         </td>                                        <td>                                            <a href="#">INV-00' . $LAST_ID . '</a>                                        </td>                                        <td><span class="invoice-amount"> ';            if ($ACCOMMODATION_TYPE->id == 1) {                $out_put .= ' <span class="bullet bullet-primary bullet-sm"></span>';            } else if ($ACCOMMODATION_TYPE->id == 2) {                $out_put .= ' <span class="bullet bullet-danger  bullet-sm"></span>';            } else if ($ACCOMMODATION_TYPE->id == 3) {                $out_put .= ' <span class="bullet bullet-dark   bullet-sm"></span>';            } else if ($ACCOMMODATION_TYPE->id == 4) {                $out_put .= ' <span class="bullet bullet-success   bullet-sm"></span>';            } else if ($ACCOMMODATION_TYPE->id == 5) {                $out_put .= ' <span class="bullet bullet-warning   bullet-sm"></span>';            } else if ($ACCOMMODATION_TYPE->id == 6) {                $out_put .= ' <span class="bullet bullet-info   bullet-sm"></span>';            } else if ($ACCOMMODATION_TYPE->id == 7) {                $out_put .= ' <span class="bullet bullet-light   bullet-sm"></span>';            }            $out_put .= ' ' . $ACCOMMODATION->title . '                                         </td>                                        <td><span class="invoice-amount">' . $CUSTOMER->full_name . '</span></td>                                                                               <td ><span class="text-danger"><b>$' . $this->getTotalPriceByAccommodationId($row['acc_id']) . '</b></span><span class="text-dark"> - ' . $this->getCountByAccommodationId($row['acc_id']) . '</span></td>';            if ($INV->payment_status == 0) {                $out_put .= '  <td><span class="badge badge-light-danger badge-pill">UNPAID..!</span></td>';            } else if ($INV->payment_status == 1) {                $out_put .= '  <td><span class="badge badge-light-success  badge-pill">PAID..!</span></td>';            }            if ($INV->status == 0) {                $out_put .= '  <td><span class="badge badge-light-danger badge-pill">NOT SEND..!</span></td>';            } else if ($INV->status == 1) {                $out_put .= '  <td><span class="badge badge-light-success  badge-pill">SEND..!</span></td>';            }            $out_put .= '       <td>                                            <div class="dropdown">                                                <span class="bx bx-dots-vertical-rounded font-medium-3 dropdown-toggle nav-hide-arrow cursor-pointer"                                                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="menu"></span>                                                <div class="dropdown-menu dropdown-menu-right">                                                    <a class="dropdown-item" target="_blank" href="monthly-invoices.php?id=' . $row['acc_id'] . '"><i class="bx bx-calendar mr-1"></i> View Bookings</a>                                                    <a class="dropdown-item" target="_blank" href="view-accommodation.php?id=' . $row['acc_id'] . '"><i class="bx bxs-institution mr-1"></i> View Property</a>                                                    <a class="dropdown-item" target="_blank" href="send-invoice.php"><i class="bx bx-window-open mr-1"></i> Send Invoice</a>                                                    <a class="dropdown-item" target="_blank" href="#"><i class="bx bx-trash mr-1"></i> delete</a>                                                </div>                                            </div>                                        </td>                                    </tr>                                     ';        }        if (!empty($out_put)) {            echo $out_put;        } else {            echo $out_put = '<p style = "color: red;font-weight: 600;">No Data Found..!</p>';        }    }    public function getBookingByAccId($date_range, $search_key, $acc_id) {        $query = "SELECT *  FROM `accommodation_booking`";        if (!empty($date_range)) {            $date_arr = explode("-", $date_range);            $start_date = explode(" ", str_replace("/", "-", $date_arr[0]));            $due_date = explode(" ", str_replace("/", "-", $date_arr[1]));            $query .= " WHERE  `check_in` between '$start_date[0]' AND '$due_date[1]' ";        }        if (!empty($search_key)) {            $query .= "AND `booking_id` LIKE '%" . $search_key . "%'";        }        if (!empty($acc_id)) {            $query .= "AND `acc_id`='$acc_id' ";        }        $query .= "ORDER BY queue ASC  ";        $db = new Database();        $result = $db->readQuery($query);        $out_put = '';        $key = 1;        while ($row = mysqli_fetch_array($result)) {            $INVOICE = new Invoice(NULL);            $ROOM = new Room($row['room_id']);            $out_put .= '<tr>                                               <td>                                            ' . $key++ . '                                         </td>                                        <td>                                            <a href="#">' . $row['booking_id'] . '</a>                                        </td>                                                                                 <td><span class="invoice-amount">' . $row['check_in'] . ' <span class="text-danger"><b> - </b></span>' . $row['check_out'] . '</span></td>                                       <td><a href="">' . $ROOM->title . '</a></td>                                        <td><span class="text-danger"><b> $' . $row['price'] . '</b></span></td>';            if ($row['status'] == 0) {                $out_put .= '  <td><span class="badge badge-light-warning badge-pill">PENDING..!</span></td>';            } elseif ($row['status'] == 1) {                $out_put .= '  <td><span class="badge badge-light-success  badge-pill">CONFIRM..!</span></td>';            } elseif ($row['status'] == 2) {                $out_put .= '  <td><span class="badge badge-light-danger  badge-pill">CANCEL..!</span></td>';            }            $out_put .= '       <td>                                            <div class="dropdown">                                                <span class="bx bx-dots-vertical-rounded font-medium-3 dropdown-toggle nav-hide-arrow cursor-pointer"                                                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="menu"></span>                                                <div class="dropdown-menu dropdown-menu-right">                                                    <a class="dropdown-item" target="_blank" href="view-booking-room-details.php?id=' . $row['room_id'] . '"><i class="bx bx-bed mr-1"></i> View Booking</a>                                                     <a class="dropdown-item" target="_blank" href="#"><i class="bx bx-trash mr-1"></i> delete</a>                                                </div>                                            </div>                                        </td>                                    </tr>                                     ';        }        if (!empty($out_put)) {            echo $out_put;        } else {            echo $out_put = '<p style = "color: red;font-weight: 600;">No Data Found..!</p>';        }    }    public function delete() {        $query = 'DELETE FROM `accommodation_booking` WHERE id="' . $this->id . '"';        $db = new Database();        return $db->readQuery($query);    }    public function deletePhotos() {        $ATTRACTION_PHOTO = new AttractionPhoto(NULL);        $allPhotos = $ATTRACTION_PHOTO->getAttractionPhotosById($this->id);        foreach ($allPhotos as $photo) {            $IMG = $ATTRACTION_PHOTO->visitor_id = $photo["visitor_id"];            unlink(Helper::getSitePath() . "upload/accommodation_booking/gallery/" . $IMG);            unlink(Helper::getSitePath() . "upload/accommodation_booking/gallery/thumb/" . $IMG);            $ATTRACTION_PHOTO->id = $photo["id"];            $ATTRACTION_PHOTO->delete();        }    }    public function arrange($key, $img) {        $query = "UPDATE `accommodation_booking` SET `queue` = '" . $key . "'  WHERE id = '" . $img . "'";        $db = new Database();        $result = $db->readQuery($query);        return $result;    }    public function getBookingsById($id) {        $query = "SELECT * FROM `accommodation_booking` WHERE `visitor_id`= $id ORDER BY queue ASC";        $db = new Database();        $result = $db->readQuery($query);        $array_res = array();        while ($row = mysqli_fetch_array($result)) {            array_push($array_res, $row);        }        return $array_res;    }    public function getCustomerBookingsById($id) {        $query = "SELECT * FROM `accommodation_booking` WHERE `customer_id`= $id ORDER BY queue ASC";        $db = new Database();        $result = $db->readQuery($query);        $array_res = array();        while ($row = mysqli_fetch_array($result)) {            array_push($array_res, $row);        }        return $array_res;    }    public function updateStatus() {        $query = "UPDATE  `accommodation_booking` SET "                . "`status` ='" . $this->status . "' "                . "WHERE `id` = '" . $this->id . "'";        $db = new Database();        $result = $db->readQuery($query);        if ($result) {            return $this->__construct($this->id);        } else {            return FALSE;        }    }    public function checkHotelBookingId($booking_id) {        $query = "SELECT id as 'check_id' FROM `accommodation_booking` WHERE `booking_id` = '" . $booking_id . "' ";        $db = new Database();        $result = mysqli_fetch_array($db->readQuery($query));        return $result['check_id'];    }    public function getCountByAccommodationId($acc_id) {        $query = "SELECT count(id)   as 'count' FROM `accommodation_booking` WHERE `acc_id` = '" . $acc_id . "' ";        $db = new Database();        $result = mysqli_fetch_array($db->readQuery($query));        return $result['count'];    }    public function getTotalPriceByAccommodationId($acc_id) {        $query = "SELECT sum(price)   as 'price' FROM `accommodation_booking` WHERE `acc_id` = '" . $acc_id . "' ";        $db = new Database();        $result = mysqli_fetch_array($db->readQuery($query));        return $result['price'];    }    public function validateBookingId($booking_id) {        $query = "SELECT `id`  FROM `accommodation_booking` WHERE `booking_id` = '" . $booking_id . "' AND `status` = 1";        $db = new Database();        $result = mysqli_fetch_array($db->readQuery($query));        if ($result) {            return TRUE;        } else {            return FALSE;        }    }    public function getIdByBookingId($booking_id) {        $query = "SELECT `acc_id` FROM `accommodation_booking` WHERE `booking_id` = '" . $booking_id . "' AND `status` = 1";        $db = new Database();        $result = mysqli_fetch_array($db->readQuery($query));        if ($result) {            return $result['acc_id'];        } else {            return FALSE;        }    }    public function getTotalPriceByAccommodationIdDateDiff($acc_id, $start_date, $end_date) {        $query = "SELECT sum(price) as 'price' FROM `accommodation_booking` WHERE `check_in` between '$start_date' AND '$end_date' AND `acc_id` = $acc_id ORDER BY queue ASC";        $db = new Database();        $result = mysqli_fetch_array($db->readQuery($query));        return $result['price'];    }}